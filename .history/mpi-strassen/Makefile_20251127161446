# Makefile for MPI Matrix Multiplication
# Parallel Computing Assignment 1

CXX = mpicxx
CXXFLAGS = -std=c++11 -O3 -Wall -Wextra
LDFLAGS = 

# Target executable
TARGET = mpi_program

# Source files
SOURCES := $(wildcard *.cpp)
OBJECTS := $(SOURCES:.cpp=.o)

# Default parameters
N ?= 1000
NP ?= 7
NUM_RUNS ?= 5

# Default target
all: $(TARGET)
	@echo "============================================"
	@echo "Build complete!"
	@echo "Executable: $(TARGET)"
	@echo "============================================"

# Build executable
$(TARGET): $(OBJECTS)
	$(CXX) $(LDFLAGS) -o $@ $^

# Compile each source file
%.o: %.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Clean build files
clean:
	rm -f $(OBJECTS) $(TARGET) *.txt *.csv
	@echo "Clean complete"

# ==========================================
# ASSIGNMENT REQUIRED TESTS
# ==========================================

# Test Case 1: Matrix sizes (100, 1000, 10000) as per assignment
test-assignment-sizes: $(TARGET)
	@echo "=========================================="
	@echo "TEST CASE: Assignment Matrix Sizes (MPI)"
	@echo "Testing: 100x100, 1000x1000, 10000x10000"
	@echo "Processes: $(NP)"
	@echo "=========================================="
	@echo ""
	@echo "Size: 100x100"
	@echo "------------------------------------------"
	mpirun -np $(NP) ./$(TARGET) 100 0
	@echo ""
	@echo "Size: 1000x1000"
	@echo "------------------------------------------"
	mpirun -np $(NP) ./$(TARGET) 1000 0
	@echo ""
	@echo "Size: 10000x10000"
	@echo "------------------------------------------"
	mpirun -np $(NP) ./$(TARGET) 10000 0
	@echo ""

# Test Case 2: Scalability Study - varying process counts (strong scaling)
test-scalability-100: $(TARGET)
	@echo "=========================================="
	@echo "TEST CASE: Scalability Study - 100x100"
	@echo "Strong Scaling (fixed problem size)"
	@echo "=========================================="
	@echo ""
	@for procs in 7; do \
		echo "Processes: $$procs"; \
		mpirun -np $$procs ./$(TARGET) 100 0; \
		echo ""; \
	done

test-scalability-1000: $(TARGET)
	@echo "=========================================="
	@echo "TEST CASE: Scalability Study - 1000x1000"
	@echo "Strong Scaling (fixed problem size)"
	@echo "=========================================="
	@echo ""
	@for procs in 7; do \
		echo "Processes: $$procs"; \
		mpirun -np $$procs ./$(TARGET) 1000 0; \
		echo ""; \
	done

test-scalability-10000: $(TARGET)
	@echo "=========================================="
	@echo "TEST CASE: Scalability Study - 10000x10000"
	@echo "Strong Scaling (fixed problem size)"
	@echo "=========================================="
	@echo ""
	@for procs in 7; do \
		echo "Processes: $$procs"; \
		mpirun -np $$procs ./$(TARGET) 10000 0; \
		echo ""; \
	done

test-scalability-all: test-scalability-100 test-scalability-1000 test-scalability-10000

    @echo "TEST CASE: Process Configuration Study"
    @echo "=========================================="
    @echo ""
    @echo "Note: This Strassen implementation requires exactly 7 processes."
    @echo "Process scaling tests are not applicable."
    @echo ""
    @echo "Testing with 7 processes on different matrix sizes instead:"
    @echo ""
    @echo "Size: 100x100"
    @echo "------------------------------------------"
    mpirun -np 7 ./$(TARGET) 100 0
    @echo ""
    @echo "Size: 1000x1000"
    @echo "------------------------------------------"
    mpirun -np 7 ./$(TARGET) 1000 0
    @echo ""
    @echo "Size: 5000x5000"
    @echo "------------------------------------------"
    mpirun -np 7 ./$(TARGET) 5000 0
    @echo ""

# ==========================================
# COMPREHENSIVE TEST SUITES
# ==========================================

# Run ALL test cases (use this for complete report data!)
test-all: $(TARGET)
	@echo "=========================================="
	@echo "RUNNING ALL TEST CASES (MPI)"
	@echo "This will take a while..."
	@echo "=========================================="
	@echo ""
	@make test-assignment-sizes
	@make test-scalability-all
	@make test-process-configs

# Quick test suite (essential tests only)
test-quick: $(TARGET)
	@echo "=========================================="
	@echo "QUICK TEST SUITE (MPI)"
	@echo "=========================================="
	@make test-assignment-sizes
	@make test-scalability-1000

# Complete benchmark for report
test-report: $(TARGET)
	@echo "=========================================="
	@echo "GENERATING COMPLETE REPORT DATA (MPI)"
	@echo "=========================================="
	@echo ""
	@echo "Starting comprehensive benchmark..."
	@echo "Output will be saved to: mpi_benchmark_results.txt"
	@echo ""
	-@$(MAKE) test-all > mpi_benchmark_results.txt 2>&1 || true
	@echo ""
	@echo "=========================================="
	@echo "BENCHMARK COMPLETE!"
	@echo "Results saved to: mpi_benchmark_results.txt"
	@echo "=========================================="

# ==========================================
# BENCHMARK LOGIC (SINGLE SIZE)
# ==========================================
# Benchmark a specific size N times and calculate average
benchmark-size: $(TARGET)
	@echo "=========================================="
	@echo "Benchmarking: $(SIZE)x$(SIZE) matrix (MPI)"
	@echo "Processes: $(NP)"
	@echo "Number of runs: $(NUM_RUNS)"
	@echo "=========================================="
	@total=0; \
	for i in $$(seq 1 $(NUM_RUNS)); do \
		echo "Run $$i/$(NUM_RUNS)..."; \
		output=$$(mpirun -np $(NP) ./$(TARGET) $(SIZE) 0 2>&1); \
		time=$$(echo "$$output" | grep "Strassen completed in" | awk '{print $$4}'); \
		if [ -n "$$time" ]; then \
			total=$$(awk "BEGIN {printf \"%.6f\", $$total + $$time}"); \
			echo "  Time: $$time seconds"; \
		else \
			echo "  Error: Could not parse time from output."; \
		fi; \
	done; \
	avg=$$(awk "BEGIN {printf \"%.6f\", $$total / $(NUM_RUNS)}"); \
	echo ""; \
	echo "Average time: $$avg seconds"; \
	echo "=========================================="

# ==========================================
# WRAPPERS FOR SPECIFIC SIZES
# ==========================================
benchmark-100: $(TARGET)
	@$(MAKE) --no-print-directory benchmark-size SIZE=100 NUM_RUNS=$(NUM_RUNS) NP=$(NP)

benchmark-1000: $(TARGET)
	@$(MAKE) --no-print-directory benchmark-size SIZE=1000 NUM_RUNS=$(NUM_RUNS) NP=$(NP)

benchmark-10000: $(TARGET)
	@$(MAKE) --no-print-directory benchmark-size SIZE=10000 NUM_RUNS=$(NUM_RUNS) NP=$(NP)

# ==========================================
# COMPARISON REPORTS (CSV GENERATION)
# ==========================================

# Compare 100, 1000, 10000 and save to CSV
compare-assignment: $(TARGET)
	@echo "=========================================="
	@echo "COMPARING ASSIGNMENT SIZES (MPI)"
	@echo "Sizes: 100, 1000, 10000"
	@echo "Processes: $(NP)"
	@echo "Runs per size: $(NUM_RUNS)"
	@echo "=========================================="
	@echo ""
	@echo "Size,Run,Time(s)" > mpi_comparison_results.csv
	
	@# Test 100
	@echo "Testing 100x100..."
	@total_100=0; \
	for i in $$(seq 1 $(NUM_RUNS)); do \
		echo "  Run $$i/$(NUM_RUNS)..."; \
		output=$$(mpirun -np $(NP) ./$(TARGET) 100 0 2>&1); \
		time=$$(echo "$$output" | grep "Strassen completed in" | awk '{print $$4}'); \
		if [ -n "$$time" ]; then \
			total_100=$$(awk "BEGIN {printf \"%.9f\", $$total_100 + $$time}"); \
			echo "100,$$i,$$time" >> mpi_comparison_results.csv; \
			echo "    Time: $$time seconds"; \
		fi; \
	done; \
	avg_100=$$(awk "BEGIN {printf \"%.6f\", $$total_100 / $(NUM_RUNS)}"); \
	echo "  Average: $$avg_100 seconds"; \
	echo ""

	@# Test 1000
	@echo "Testing 1000x1000..."
	@total_1000=0; \
	for i in $$(seq 1 $(NUM_RUNS)); do \
		echo "  Run $$i/$(NUM_RUNS)..."; \
		output=$$(mpirun -np $(NP) ./$(TARGET) 1000 0 2>&1); \
		time=$$(echo "$$output" | grep "Strassen completed in" | awk '{print $$4}'); \
		if [ -n "$$time" ]; then \
			total_1000=$$(awk "BEGIN {printf \"%.9f\", $$total_1000 + $$time}"); \
			echo "1000,$$i,$$time" >> mpi_comparison_results.csv; \
			echo "    Time: $$time seconds"; \
		fi; \
	done; \
	avg_1000=$$(awk "BEGIN {printf \"%.6f\", $$total_1000 / $(NUM_RUNS)}"); \
	echo "  Average: $$avg_1000 seconds"; \
	echo ""

	@# Test 10000
	@echo "Testing 10000x10000..."
	@total_10000=0; \
	for i in $$(seq 1 $(NUM_RUNS)); do \
		echo "  Run $$i/$(NUM_RUNS)..."; \
		output=$$(mpirun -np $(NP) ./$(TARGET) 10000 0 2>&1); \
		time=$$(echo "$$output" | grep "Strassen completed in" | awk '{print $$4}'); \
		if [ -n "$$time" ]; then \
			total_10000=$$(awk "BEGIN {printf \"%.9f\", $$total_10000 + $$time}"); \
			echo "10000,$$i,$$time" >> mpi_comparison_results.csv; \
			echo "    Time: $$time seconds"; \
		fi; \
	done; \
	avg_10000=$$(awk "BEGIN {printf \"%.6f\", $$total_10000 / $(NUM_RUNS)}"); \
	echo "  Average: $$avg_10000 seconds"; \
	echo ""
	
	@echo "=========================================="
	@echo "SUMMARY (Average of $(NUM_RUNS) runs)"
	@echo "=========================================="
	@echo "  100x100:      $$avg_100 seconds"
	@echo "  1000x1000:    $$avg_1000 seconds"
	@echo "  10000x10000:  $$avg_10000 seconds"
	@echo "=========================================="
	@echo "Results saved to: mpi_comparison_results.csv"

# ==========================================
# SHORTCUT TARGETS
# ==========================================

# Visual comparison (just prints to screen, doesn't make CSV)
compare-all:
	@$(MAKE) --no-print-directory benchmark-100
	@echo ""
	@$(MAKE) --no-print-directory benchmark-1000
	@echo ""
	@$(MAKE) --no-print-directory benchmark-10000

# Quick comparison with 3 runs
compare-quick:
	@$(MAKE) --no-print-directory compare-assignment NUM_RUNS=3

# Full comparison with 10 runs for report
compare-report:
	@$(MAKE) --no-print-directory compare-assignment NUM_RUNS=10

# ==========================================
# DATA EXPORT FOR ANALYSIS
# ==========================================

# Generate CSV data for plotting - scalability analysis
export-csv-scalability: $(TARGET)
	@echo "Generating scalability CSV data..."
	@echo "size,processes,time,speedup" > mpi_scalability_data.csv
	@echo "# Scalability data for 1000x1000"
	@# Get baseline (1 process)
	@baseline=$$(mpirun -np 7 ./$(TARGET) 1000 0 2>&1 | grep "Strassen completed in" | awk '{print $$4}'); \
	echo "Baseline (7 processes): $$baseline seconds"; \
	for procs in 7; do \
		echo "Testing $$procs processes..."; \
		time=$$(mpirun -np $$procs ./$(TARGET) 1000 0 2>&1 | grep "Strassen completed in" | awk '{print $$4}'); \
		speedup=$$(awk "BEGIN {printf \"%.4f\", $$baseline / $$time}"); \
		echo "1000,$$procs,$$time,$$speedup" >> mpi_scalability_data.csv; \
	done
	@echo "Data saved to: mpi_scalability_data.csv"

# ==========================================
# PLATFORM-SPECIFIC TESTS
# ==========================================

# Test on current machine
test-current-machine: $(TARGET)
	@echo "=========================================="
	@echo "TESTING ON CURRENT MACHINE (MPI)"
	@echo "=========================================="
	@echo ""
	@echo "System Information:"
	@echo "------------------------------------------"
	@make info
	@echo ""
	@echo "Running benchmarks..."
	@echo "------------------------------------------"
	@make test-assignment-sizes
	@make test-scalability-1000

# Multiple machine test (for assignment requirement)
test-machine-1: test-current-machine
	@echo "Machine 1 tests complete (MPI)"
	@echo "Results for Machine 1 - MPI" > mpi_machine1_results.txt
	@make test-assignment-sizes >> mpi_machine1_results.txt 2>&1
	@make test-scalability-1000 >> mpi_machine1_results.txt 2>&1

test-machine-2: test-current-machine
	@echo "Machine 2 tests complete (MPI)"
	@echo "Results for Machine 2 - MPI" > mpi_machine2_results.txt
	@make test-assignment-sizes >> mpi_machine2_results.txt 2>&1
	@make test-scalability-1000 >> mpi_machine2_results.txt 2>&1

test-machine-3: test-current-machine
	@echo "Machine 3 tests complete (MPI)"
	@echo "Results for Machine 3 - MPI" > mpi_machine3_results.txt
	@make test-assignment-sizes >> mpi_machine3_results.txt 2>&1
	@make test-scalability-1000 >> mpi_machine3_results.txt 2>&1

# ==========================================
# CLUSTER-SPECIFIC TESTS
# ==========================================

# Test on HPCC cluster (gateway.hpcc.vn)
test-cluster: $(TARGET)
	@echo "=========================================="
	@echo "TESTING ON HPCC CLUSTER"
	@echo "=========================================="
	@echo ""
	@make test-assignment-sizes NP=7
	@make test-scalability-1000

# ==========================================
# UTILITY TARGETS
# ==========================================

# Quick test with small matrix
test: $(TARGET)
	@echo "==================================="
	@echo "Quick Test (100x100, 7 processes)"
	@echo "==================================="
	mpirun -np 7 ./$(TARGET) 100 0

# Run with default parameters
run: $(TARGET)
	@echo "Running with default parameters (N=$(N), NP=$(NP))..."
	mpirun -np $(NP) ./$(TARGET) $(N) 0

# Check MPI support
check-mpi:
	@echo "Checking MPI support..."
	@which mpirun > /dev/null 2>&1 && echo "✓ mpirun found" || echo "✗ mpirun NOT found"
	@which mpicxx > /dev/null 2>&1 && echo "✓ mpicxx found" || echo "✗ mpicxx NOT found"
	@mpicxx --version 2>/dev/null | head -n 1 || echo "Unable to get MPI version"

# Show system information
info:
	@echo "=========================================="
	@echo "System Information (MPI)"
	@echo "=========================================="
	@echo "Compiler: $(CXX)"
	@mpicxx --version 2>/dev/null | head -n 1 || echo "MPI compiler info unavailable"
	@echo ""
	@echo "CPU Info:"
	@if [ -f /proc/cpuinfo ]; then \
		echo "  Model: $$(grep 'model name' /proc/cpuinfo | head -n 1 | cut -d: -f2 | sed 's/^[ \t]*//')"; \
		echo "  Cores: $$(grep -c ^processor /proc/cpuinfo)"; \
		echo "  Threads per core: $$(lscpu | grep 'Thread(s) per core' | awk '{print $$4}')"; \
	else \
		echo "  (CPU info not available)"; \
	fi
	@echo ""
	@echo "Memory Info:"
	@if [ -f /proc/meminfo ]; then \
		echo "  Total: $$(grep MemTotal /proc/meminfo | awk '{print $$2/1000/1000 \" GB"}')"; \
	else \
		echo "  (Memory info not available)"; \
	fi
	@echo ""
	@echo "MPI Info:"
	@make check-mpi 2>/dev/null || echo "  Unable to check MPI"

# Help message
help:
	@echo "=========================================="
	@echo "MPI Matrix Multiplication Makefile"
	@echo "=========================================="
	@echo ""
	@echo "BUILD:"
	@echo "  make              - Build the program"
	@echo "  make clean        - Remove all build and result files"
	@echo ""
	@echo "ASSIGNMENT TESTS (Required for report):"
	@echo "  make test-assignment-sizes      - Test 100, 1000, 10000 (REQUIRED)"
	@echo "  make test-scalability-all       - Process scaling for all sizes (REQUIRED)"
	@echo "  make test-process-configs       - Various process configurations"
	@echo ""
	@echo "INDIVIDUAL TEST CASES:"
	@echo "  make test-scalability-100       - Process scaling for 100x100"
	@echo "  make test-scalability-1000      - Process scaling for 1000x1000"
	@echo "  make test-scalability-10000     - Process scaling for 10000x10000"
	@echo ""
	@echo "COMPREHENSIVE SUITES:"
	@echo "  make test-all                   - Run ALL test cases"
	@echo "  make test-quick                 - Essential tests only"
	@echo "  make test-report                - Generate complete report data"
	@echo ""
	@echo "BENCHMARKING:"
	@echo "  make benchmark-100              - Benchmark 100x100 ($(NUM_RUNS) runs)"
	@echo "  make benchmark-1000             - Benchmark 1000x1000 ($(NUM_RUNS) runs)"
	@echo "  make benchmark-10000            - Benchmark 10000x10000 ($(NUM_RUNS) runs)"
	@echo "  make compare-assignment         - Compare all sizes with averaging"
	@echo "  make compare-quick              - Quick comparison (3 runs)"
	@echo "  make compare-report             - Full comparison (10 runs)"
	@echo ""
	@echo "MULTI-MACHINE TESTING:"
	@echo "  make test-machine-1             - Test on machine 1 (save to file)"
	@echo "  make test-machine-2             - Test on machine 2 (save to file)"
	@echo "  make test-machine-3             - Test on machine 3 (save to file)"
	@echo "  make test-cluster               - Test on HPCC cluster"
	@echo ""
	@echo "DATA EXPORT:"
	@echo "  make export-csv-scalability     - Export scalability data in CSV"
	@echo ""
	@echo "UTILITIES:"
	@echo "  make test                       - Quick test (100x100, 7 procs)"
	@echo "  make run                        - Run with default params"
	@echo "  make check-mpi                  - Check MPI availability"
	@echo "  make info                       - Show system information"
	@echo "  make help                       - Show this help"
	@echo ""
	@echo "PARAMETERS:"
	@echo "  N=<size>          - Matrix size (default: 1000)"
	@echo "  NP=<procs>        - Number of MPI processes (default: 7)"
	@echo "  NUM_RUNS=<runs>   - Number of benchmark runs (default: 5)"
	@echo ""
	@echo "MANUAL EXECUTION:"
	@echo "  mpirun -np <procs> ./$(TARGET) <size> <check_err>"
	@echo ""
	@echo "  Examples:"
	@echo "    mpirun -np 7 ./$(TARGET) 1000 0"
	@echo "    mpirun -np 7 ./$(TARGET) 10000 0"
	@echo "    make run N=2000 NP=7"
	@echo ""
	@echo "RECOMMENDED FOR ASSIGNMENT:"
	@echo "  1. make test-report             - Generate all data"
	@echo "  2. make compare-report          - Get averaged results"
	@echo "  3. make test-machine-1          - Test on your laptop"
	@echo "  4. make test-machine-2          - Test on lab machine"
	@echo "  5. make test-cluster            - Test on HPCC cluster"

.PHONY: all clean run test test-assignment-sizes test-scalability-100 \
        test-scalability-1000 test-scalability-10000 test-scalability-all \
        test-process-configs test-all test-quick test-report \
        benchmark-size benchmark-100 benchmark-1000 benchmark-10000 \
        compare-assignment compare-all compare-quick compare-report \
        export-csv-scalability test-current-machine test-machine-1 \
        test-machine-2 test-machine-3 test-cluster check-mpi info help